<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameGenie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.15.1/beautify-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="bg-gradient-to-br from-gray-900 to-indigo-900 min-h-screen flex flex-col antialiased text-gray-100">
    
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-gray-900/60 backdrop-blur-xl shadow-2xl rounded-3xl overflow-hidden border-2 border-indigo-600/30 relative">
            <!-- Subtle Gradient Overlay -->
            <div class="absolute inset-0 bg-gradient-to-br from-indigo-900/40 to-purple-900/40 opacity-50 pointer-events-none"></div>
            
            <div class="relative z-10 bg-gradient-to-r from-indigo-700/80 to-purple-600/80 text-white py-8 px-10">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-5xl font-extrabold tracking-tight flex items-center space-x-4">
                            <i class="fas fa-gamepad text-indigo-300"></i>
                            <span>GameGenie</span>
                            <span class="text-sm bg-purple-600/70 px-3 py-1 rounded-full border border-white/20">AI-Powered</span>
                        </h1>
                        <p class="mt-3 text-indigo-100 text-xl opacity-80">Unleash Your Game Development Creativity</p>
                    </div>
                    <div class="hidden md:block">
                        <div class="bg-white/10 rounded-full p-4 border border-white/20 backdrop-blur-sm">
                            <i class="fas fa-laptop-code text-4xl text-white/80"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 space-y-6">
                        <div>
                            <label for="gamePrompt" class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                <i class="fas fa-lightbulb mr-2 text-indigo-400"></i>
                                Game Concept
                            </label>
                            <textarea 
                                id="gamePrompt" 
                                rows="4" 
                                class="w-full rounded-xl bg-gray-800/60 border border-gray-700/50 text-white placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 backdrop-blur-sm"
                                placeholder="Describe your dream game! 
• Retro pixel art Snake game
• Physics-based puzzle platformer
• Space invaders with unique mechanics"
                            ></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                    <i class="fas fa-cogs mr-2 text-indigo-400"></i>
                                    Game Complexity
                                </label>
                                <select 
                                    id="complexityLevel" 
                                    class="w-full rounded-xl bg-gray-800/60 border border-gray-700/50 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 backdrop-blur-sm"
                                >
                                    <option value="basic">Basic</option>
                                    <option value="intermediate" selected>Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                    <i class="fas fa-palette mr-2 text-indigo-400"></i>
                                    Game Style
                                </label>
                                <select 
                                    id="gameStyle" 
                                    class="w-full rounded-xl bg-gray-800/60 border border-gray-700/50 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 backdrop-blur-sm"
                                >
                                    <option value="minimal">Minimal</option>
                                    <option value="professional" selected>Professional</option>
                                    <option value="vibrant">Vibrant</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="bg-gray-800/50 rounded-xl p-5 h-full border border-gray-700/30 backdrop-blur-sm">
                            <h3 class="text-xl font-semibold text-white mb-3 flex items-center">
                                <i class="fas fa-rocket mr-3 text-indigo-400"></i>Game Generation Tips
                            </h3>
                            <ul class="space-y-2 text-sm text-gray-300">
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle mr-3 text-green-500"></i>
                                    Be specific about game mechanics
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle mr-3 text-green-500"></i>
                                    Describe core gameplay loop
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle mr-3 text-green-500"></i>
                                    Mention unique twists
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle mr-3 text-green-500"></i>
                                    Consider player interactions
                                </li>
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle mr-3 text-green-500"></i>
                                    Think about visual style
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <button 
                        id="generateBtn" 
                        class="flex-1 bg-indigo-600/80 text-white py-4 px-6 rounded-xl hover:bg-indigo-700/90 transition duration-300 font-semibold flex items-center justify-center space-x-3 transform hover:scale-[1.02] border border-white/20"
                    >
                        <i class="fas fa-magic mr-2"></i>
                        Generate Game
                    </button>
                    <button 
                        id="deleteGameBtn" 
                        class="bg-red-600/80 text-white py-4 px-6 rounded-xl hover:bg-red-700/90 transition duration-300 font-semibold flex items-center justify-center space-x-3 hidden transform hover:scale-[1.02] border border-white/20"
                    >
                        <i class="fas fa-trash-alt mr-2"></i>
                        Delete Game
                    </button>
                </div>

                <div id="loadingSpinner" class="mt-6 text-center hidden">
                    <div class="inline-block animate-spin w-16 h-16 border-[6px] border-current border-t-transparent text-indigo-600 rounded-full"></div>
                    <p class="mt-4 text-gray-300 text-lg">Generating your game...</p>
                </div>

                <div id="previewContainer" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-white">
                            <i class="fas fa-eye mr-2"></i>Game Preview
                        </h2>
                        <div class="flex space-x-3">
                            <button id="fullscreenBtn" class="text-indigo-300 hover:text-white transition duration-300 flex items-center bg-gray-800 px-3 py-2 rounded-lg">
                                <i class="fas fa-expand mr-2"></i>
                                Fullscreen
                            </button>
                            <button id="reloadGameBtn" class="text-green-300 hover:text-white transition duration-300 flex items-center bg-gray-800 px-3 py-2 rounded-lg">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Reload
                            </button>
                        </div>
                    </div>
                    <div id="gamePreview" class="bg-gray-800 rounded-lg p-4 min-h-[600px] relative border-2 border-gray-700 shadow-inner overflow-hidden">
                        <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-xl">
                            Game will appear here
                        </div>
                    </div>
                </div>
                    
                <div id="codeContainer" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-white">
                            <i class="fas fa-code mr-2"></i>Game Source Code
                        </h2>
                        <div class="flex space-x-3">
                            <button id="copyCodeBtn" class="text-indigo-300 hover:text-white transition duration-300 flex items-center bg-gray-800 px-3 py-2 rounded-lg">
                                <i class="fas fa-copy mr-2"></i>
                                Copy Code
                            </button>
                            <button id="downloadCodeBtn" class="text-green-300 hover:text-white transition duration-300 flex items-center bg-gray-800 px-3 py-2 rounded-lg">
                                <i class="fas fa-download mr-2"></i>
                                Download
                            </button>
                        </div>
                    </div>
                    <pre class="rounded-lg max-h-[500px] overflow-auto"><code id="generatedCode" class="language-html"></code></pre>
                </div>
            </div>
        </div>
        
                        <!-- New row for generation speed and Gemini model -->
                <div class="mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                            <i class="fas fa-tachometer-alt mr-2 text-indigo-400"></i>
                            Generation Speed & Quality
                        </label>
                        <select 
                            id="generationSpeed" 
                            class="w-full rounded-xl bg-gray-800/60 border border-gray-700/50 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 backdrop-blur-sm"
                        >
                            <option value="very-slow">Very Slow (Highest Quality)</option>
                            <option value="slow">Slow (High Quality)</option>
                            <option value="normal" selected>Normal (Balanced)</option>
                            <option value="fast">Fast (Lower Quality)</option>
                            <option value="very-fast">Very Fast (Lowest Quality)</option>
                        </select>
                    </div>
        
        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                <i class="fas fa-robot mr-2 text-indigo-400"></i>
                Gemini Model (Newest to Oldest)
            </label>
            <select 
                id="geminiModel" 
                class="w-full rounded-xl bg-gray-800/60 border border-gray-700/50 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 backdrop-blur-sm"
            >
                <option value="auto" selected>(Automatic)</option>
                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
                <option value="gemini-exp-1206">Gemini Experimental (1206)</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            </select>
        </div>
    </div>
    </div>

    <script>
        // Placeholder Gemini API Key - replace with your own
        const GEMINI_API_KEY = 'AIzaSyCd0okpIKnQ7rSe0fw-EuEuKKZwJdqNlKM';
        
        async function checkProfanity(text) {
            const PROFANITY_API_ENDPOINT = 'https://www.purgomalum.com/service/containsprofanity';
            
            try {
                // Implement more robust error handling and timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5-second timeout
                
                const response = await fetch(`${PROFANITY_API_ENDPOINT}?text=${encodeURIComponent(text)}`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.warn('Profanity check service unavailable. Proceeding with generation.');
                    return false;
                }
                
                const result = await response.text();
                return result === 'true';
            } catch (error) {
                console.error('Profanity check error:', error);
                
                // More detailed error handling
                if (error.name === 'AbortError') {
                    console.warn('Profanity check timed out. Proceeding with generation.');
                }
                
                return false; // Default to safe if API fails
            }
        }

        // Enhanced game generation prompt
        function createDetailedPrompt(contextPrompt, complexity, style, generationSpeed) {
            const speedInstructions = {
                'very-slow': `
                    ULTRA-DETAILED MODE: 
                    - Spend maximum time analyzing and refining every aspect of the game
                    - Implement comprehensive error handling and edge cases
                    - Create highly modular and extensible code structure
                    - Optimize for maximum code quality and performance
                    - Provide multiple layers of input validation
                    - Include extensive comments and documentation
                `,
                'slow': `
                    DETAILED MODE:
                    - Thoroughly analyze game requirements
                    - Implement robust error handling
                    - Create clean, modular code structure
                    - Provide comprehensive input validation
                    - Include clear comments and documentation
                `,
                'normal': `
                    BALANCED MODE:
                    - Focus on core functionality and clean implementation
                    - Basic error handling and input validation
                    - Maintain readability and basic performance optimization
                `,
                'fast': `
                    QUICK MODE:
                    - Prioritize rapid implementation
                    - Minimal error handling
                    - Simplified code structure
                    - Focus on core game mechanics
                `,
                'very-fast': `
                    ULTRA-QUICK MODE:
                    - Absolute minimum implementation
                    - Bare essential functionality
                    - Minimal code complexity
                    - Fastest possible generation
                `
            };

            const complexityInstructions = {
                basic: 'Develop a straightforward tool or app with minimal features, simple logic, and intuitive interactions.',
                intermediate: 'Build an application with moderate complexity, incorporating multiple features, user state management, and responsive design.',
                advanced: 'Create a highly sophisticated app with advanced functionality, dynamic state handling, integrations, and extensive user interaction options.'
            };

            const styleInstructions = {
                minimal: 'Design a clean, minimalist interface with an emphasis on usability and clear, modern design elements.',
                vibrant: 'Use a visually engaging design with bold colors, playful animations, and an interactive user experience.',
                professional: 'Craft a sleek, professional aesthetic with a focus on functionality, subtle gradients, and polished UI components.'
            };

            return `Generate a complete, self-contained HTML5 application with these specifications:

GENERATION STRATEGY:
${speedInstructions[generationSpeed]}

ABSOLUTE REQUIREMENTS:
- ENTIRE application must be in ONE HTML file
- NO external dependencies (e.g., no external CSS or JS files)
- MUST run immediately in browser
- FULLY SELF-EXECUTABLE
- Cross-browser compatible
- Mobile-responsive
- Performance optimized

APPLICATION CONTEXT:
${contextPrompt}

COMPLEXITY STRATEGY: 
${complexityInstructions[complexity]}

VISUAL DESIGN:
${styleInstructions[style]}

IMPLEMENTATION GUIDELINES:
- Pure JavaScript implementation
- Efficient, modular, and readable code
- Error-resistant structure
- Responsive design for various screen sizes
- Avoid unnecessary global variables
- Use modern ES6+ features (e.g., arrow functions, classes, modules)
- Include robust error handling
- Prioritize user accessibility and experience
- Optimize for performance without compromising functionality

CRITICAL: Produce RAW, EXECUTABLE CODE without any additional explanatory text.`;
        }

        // Utility function to handle API errors
        function handleApiError(error) {
            console.error('Game Generation Error:', error);
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // More detailed error logging and user feedback
            const errorDetails = {
                'network': 'Check your internet connection',
                'unauthorized': 'Invalid API credentials',
                'rate-limit': 'Too many requests. Please try again later',
                'service-unavailable': 'Game generation service is currently down'
            };
            
            // Determine error type based on error object or status
            const errorType = error.status === 429 ? 'rate-limit' :
                              error.status === 401 ? 'unauthorized' :
                              error.message.includes('network') ? 'network' : 
                              'service-unavailable';
            
            const errorMessage = document.createElement('div');
            errorMessage.innerHTML = `
                <div class="bg-red-600 text-white p-4 rounded-lg mt-4 animate-pulse">
                    <h3 class="font-bold mb-2">Game Generation Failed</h3>
                    <p>Error: ${errorDetails[errorType]}</p>
                    <small class="mt-2 block">Technical details: ${sanitizeHTML(error.message)}</small>
                    <div class="mt-3 text-sm">
                        <strong>Troubleshooting Tips:</strong>
                        <ul class="list-disc pl-5">
                            ${errorType === 'network' ? '<li>Check your internet connection</li>' : ''}
                            ${errorType === 'unauthorized' ? '<li>Verify your API key</li>' : ''}
                            <li>Refresh the page and try again</li>
                        </ul>
                    </div>
                </div>
            `;
            
            loadingSpinner.innerHTML = '';
            loadingSpinner.appendChild(errorMessage);
        }

        // Safe HTML sanitization to prevent XSS
        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            
            // Additional sanitization steps
            const sanitizedContent = div.innerHTML
                .replace(/</g, '&lt;')   // Escape < character
                .replace(/>/g, '&gt;')   // Escape > character
                .replace(/"/g, '&quot;') // Escape double quotes
                .replace(/'/g, '&#39;')  // Escape single quotes
                .replace(/&/g, '&amp;'); // Escape ampersand
            
            return sanitizedContent;
        }
        
        // Add this function to the existing script, just before the 'Game generation event listener'

        async function improveGeneratedGame(gameCode, gamePrompt, complexity, gameStyle, generationSpeed, geminiModel) {
            const improvementPrompt = `Improve the following HTML game code based on these criteria:
            Game Concept: ${gamePrompt}
            Complexity: ${complexity}
            Style: ${gameStyle}
            Generation Speed: ${generationSpeed}
        
            Code:
            \`\`\`html
            ${gameCode}
            \`\`\`
        
            Focus on:
            - Fixing any bugs or errors.
            - Improving performance and efficiency.
            - Enhancing user experience.
            - Adding comments for clarity.
        
            Return ONLY the improved HTML code.`;
        
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent`, { // Use the passed-in geminiModel
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': GEMINI_API_KEY
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: improvementPrompt
                            }]
                        }]
                    })
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                return data.candidates[0].content.parts[0].text
                    .replace(/```html/g, '')
                    .replace(/```/g, '')
                    .trim();
            } catch (error) {
                console.error('Game Improvement Error:', error);
                return null; // Return null to indicate failure
            }
        }
        
        async function selectModelAutomatically(gamePrompt, complexity, style, generationSpeed, modelRanking) {
          const analysisModel = 'gemini-2.0-flash-exp'; // Default analysis model.
          const promptAnalysisPrompt = `Analyze the following game generation request and recommend the most suitable Gemini AI model:
        
          Game Concept: ${gamePrompt}
          Complexity: ${complexity}
          Style: ${style}
          Generation Speed: ${generationSpeed}
        
          EVALUATION CRITERIA:
          1. Complexity of the game concept (simple, moderate, or high).
          2. The degree of creative interpretation required for unique or abstract ideas.
          3. Technical sophistication needed for execution (e.g., advanced algorithms, unique designs).
          4. Speed requirements—prioritize models capable of generating results quickly.
          5. Reliability and alignment with modern generative AI standards.
        
          ADDITIONAL INSTRUCTIONS:
          - Use the most recently released models if all other factors are equal.
          - Choose from this list only: ${modelRanking.join(', ')}.
          - If you cannot determine the most appropriate model with high confidence, recommend the newest model by default.
          - Provide a brief justification for your selection based on the above criteria.
          - ONLY return the model name.`;
        
          try {
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/${analysisModel}:generateContent`,
              {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-goog-api-key': GEMINI_API_KEY,
                },
                body: JSON.stringify({
                  contents: [
                    {
                      parts: [
                        {
                          text: promptAnalysisPrompt,
                        },
                      ],
                    },
                  ],
                  generationConfig: {
                    temperature: 0.2,
                    maxOutputTokens: 128,
                  },
                }),
              }
            );
        
            if (!response.ok) {
              console.warn('API response was not OK. Falling back to the highest-ranked model.');
              return modelRanking[0]; // Default to the top-ranked model.
            }
        
            const data = await response.json();
        
            // Extract model recommendation and confidence from API response.
            const recommendedModel = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
            let confidence = data?.candidates?.[0]?.confidence ?? null;
        
            // Log the API recommendation for debugging purposes.
            console.warn('API Recommendation:', recommendedModel, 'Confidence:', confidence);
        
            // Handle null confidence.
            if (confidence === null) {
              console.warn(
                'Confidence score is null. Assuming default medium confidence and applying fallback logic.'
              );
              confidence = 0.5; // Default medium confidence.
            }
        
            // Validate the recommendation.
            if (recommendedModel && modelRanking.includes(recommendedModel)) {
              // If confidence is high enough or medium (null case), use the recommendation.
              if (confidence >= 0.8 || (confidence >= 0.5 && recommendedModel === modelRanking[0])) {
                return recommendedModel;
              } else {
                console.warn(
                  'API recommendation confidence is low or unconvincing. Falling back to heuristic logic.'
                );
              }
            } else {
              console.warn(
                'API recommended an unsupported or invalid model. Falling back to heuristic logic.'
              );
            }
        
            // Heuristic logic: Default to the most preferred model in the ranking list.
            return modelRanking[0];
          } catch (error) {
            console.error('Error during model selection:', error);
            // Fallback in case of API failure.
            return modelRanking[0];
          }
        }

        // Game generation event listener
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const generationSpeed = document.getElementById('generationSpeed').value;
            const gamePrompt = document.getElementById('gamePrompt').value;
            const complexityLevel = document.getElementById('complexityLevel').value;
            const gameStyle = document.getElementById('gameStyle').value;
            let geminiModel = document.getElementById('geminiModel').value;
            const loadingSpinner = document.getElementById('loadingSpinner');
            const previewContainer = document.getElementById('previewContainer');
            const codeContainer = document.getElementById('codeContainer');
            const gamePreview = document.getElementById('gamePreview');
            const generatedCodeElement = document.getElementById('generatedCode');
            const deleteGameBtn = document.getElementById('deleteGameBtn');
        
            const modelNames = {
                'gemini-2.0-flash-exp': 'Gemini 2.0 Flash Experimental',
                'gemini-1.5-flash': 'Gemini 1.5 Flash',
                'gemini-exp-1206': 'Gemini Experimental 1206',
                'gemini-exp-1121': 'Gemini Experimental 1121',
                'gemini-1.5-pro': 'Gemini 1.5 Pro',
                'gemini-1.5-flash-8b': 'Gemini 1.5 Flash 8b',
                'learnlm-1.5-pro-experimental': 'LLM 1.5 Pro Experimental',
                'auto': 'Automatic Model Selection'
            };
        
            // Input validation
            if (!gamePrompt.trim()) {
                alert('Please describe your game concept!');
                return;
            }
        
            // Profanity check
            try {
                const hasProfanity = await checkProfanity(gamePrompt);
                if (hasProfanity) {
                    alert('Your game description contains inappropriate language. Please revise.');
                    return;
                }
            } catch (error) {
                console.error('Profanity check failed:', error);
            }
            
            // Timer variables
            let startTime, timerInterval;
        
            const startTimer = (message) => {
                startTime = performance.now();
                timerInterval = setInterval(() => {
                    const elapsedTime = ((performance.now() - startTime) / 1000).toFixed(1);
                    loadingSpinner.querySelector('p').textContent = `${message} (${elapsedTime}s)`;
                }, 100);
            };
        
            const stopTimer = () => {
                clearInterval(timerInterval);
            };
        
            // Reset UI
            loadingSpinner.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            codeContainer.classList.add('hidden');
            gamePreview.innerHTML = '';
            deleteGameBtn.classList.add('hidden');
            
            const modelRanking = [
                'gemini-2.0-flash-exp',
                'gemini-exp-1206',
                'gemini-exp-1121',
                'learnlm-1.5-pro-experimental',
                'gemini-1.5-pro',
                'gemini-1.5-flash',
                'gemini-1.5-flash-8b',
            ];
        
            if (geminiModel === 'auto') {
                try {
                    geminiModel = await selectModelAutomatically(
                        gamePrompt,
                        complexityLevel,
                        gameStyle,
                        generationSpeed,
                        modelRanking
                    );
                } catch (error) {
                    console.error('Model auto-selection failed:', error);
                    alert('Automatic model selection failed. Please try selecting a model manually.');
                    return;
                }
            }
        
            // Update loading text with specific model name
            //loadingSpinner.querySelector('p').textContent = `${modelNames[geminiModel]} is generating your game...`;
        
            try {
              
                startTimer(`${modelNames[geminiModel] || 'Gemini'} is generating your game...`);
                const detailedPrompt = createDetailedPrompt(gamePrompt, complexityLevel, gameStyle);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': GEMINI_API_KEY
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: detailedPrompt
                            }]
                        }]
                    })
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                let gameCode = data.candidates[0].content.parts[0].text
                    .replace(/```html/g, '')
                    .replace(/```/g, '')
                    .trim();
        
                // Update loading text for refinement
                //loadingSpinner.querySelector('p').textContent = `${modelNames[geminiModel]} is refining your game...`;
                
                // Stop the generation timer
                stopTimer();
        
                // Start the refining timer
                startTimer(`${modelNames[geminiModel] || 'Gemini'} is refining your game...`);
                const improvedGameCode = await improveGeneratedGame(gameCode, gamePrompt, complexityLevel, gameStyle, generationSpeed, geminiModel); // Pass geminiModel here!
                
                // Use improved code if successfully generated
                if (improvedGameCode) {
                    gameCode = improvedGameCode;
                }
                
                // Stop the generation timer
                stopTimer();
        
                // Beautify HTML for readability
                const beautifiedCode = html_beautify(gameCode, {
                    indent_size: 2,
                    wrap_line_length: 80
                });
        
                // Create game iframe
                const gameFrame = document.createElement('iframe');
                gameFrame.id = 'gameFrame';
                gameFrame.srcdoc = gameCode;
                gameFrame.style.width = '100%';
                gameFrame.style.height = '100%';
                gameFrame.style.border = 'none';
                gameFrame.style.position = 'absolute';
                gameFrame.style.top = '0';
                gameFrame.style.left = '0';
        
                gamePreview.innerHTML = '';
                gamePreview.appendChild(gameFrame);
        
                // Syntax highlighting and code display
                generatedCodeElement.textContent = beautifiedCode;
                Prism.highlightElement(generatedCodeElement);
        
                // Update UI
                loadingSpinner.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                codeContainer.classList.remove('hidden');
                deleteGameBtn.classList.remove('hidden');
        
            } catch (error) {
                handleApiError(error);
            }
        });

        // Delete game functionality
        document.getElementById('deleteGameBtn').addEventListener('click', () => {
            const gamePreview = document.getElementById('gamePreview');
            const previewContainer = document.getElementById('previewContainer');
            const codeContainer = document.getElementById('codeContainer');
            const deleteGameBtn = document.getElementById('deleteGameBtn');

            gamePreview.innerHTML = `
                <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-xl">
                    Game will appear here
                </div>
            `;
            previewContainer.classList.add('hidden');
            codeContainer.classList.add('hidden');
            deleteGameBtn.classList.add('hidden');
        });

        // Fullscreen game preview
        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            const gameFrame = document.getElementById('gameFrame');
            
            if (gameFrame) {
                if (gameFrame.requestFullscreen) {
                    gameFrame.requestFullscreen();
                } else if (gameFrame.mozRequestFullScreen) {
                    gameFrame.mozRequestFullScreen();
                } else if (gameFrame.webkitRequestFullscreen) {
                    gameFrame.webkitRequestFullscreen();
                } else if (gameFrame.msRequestFullscreen) {
                    gameFrame.msRequestFullscreen();
                }
            }
        });

        // Reload game functionality
        document.getElementById('reloadGameBtn').addEventListener('click', () => {
            const gameFrame = document.getElementById('gameFrame');
            if (gameFrame) {
                gameFrame.contentWindow.location.reload();
            }
        });

        // Copy code to clipboard
        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            const generatedCodeElement = document.getElementById('generatedCode');
            const copyBtn = document.getElementById('copyCodeBtn');
            
            navigator.clipboard.writeText(generatedCodeElement.textContent).then(() => {
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Copied!
                `;
                
                setTimeout(() => {
                    copyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Copy Code
                    `;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Copy Failed
                `;
                
                setTimeout(() => {
                    copyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Copy Code
                    `;
                }, 2000);
            });
        });

        // Download game code
        document.getElementById('downloadCodeBtn').addEventListener('click', () => {
            const generatedCodeElement = document.getElementById('generatedCode');
            const gameCode = generatedCodeElement.textContent;
            const blob = new Blob([gameCode], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'generated_game.html';
            link.click();
        });
    </script>
</body>
</html>
