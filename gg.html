<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameGenie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="bg-gradient-to-br from-gray-900 to-indigo-900 min-h-screen flex flex-col antialiased text-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-gray-800 shadow-2xl rounded-3xl overflow-hidden border-4 border-indigo-600">
            <div class="bg-gradient-to-r from-indigo-700 to-purple-600 text-white py-8 px-10">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-5xl font-extrabold tracking-tight flex items-center">
                            <i class="fas fa-gamepad mr-4"></i>GameGenie
                            <span class="ml-4 bg-purple-500 text-sm px-3 py-1 rounded-full">AI-Powered</span>
                        </h1>
                        <p class="mt-3 text-indigo-100 text-xl">Unleash Your Game Development Creativity</p>
                    </div>
                    <div class="hidden md:block">
                        <div class="bg-white/10 rounded-full p-4">
                            <i class="fas fa-laptop-code text-4xl text-white"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-8 bg-gray-900">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div>
                            <label for="gamePrompt" class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-lightbulb mr-2"></i>Game Concept
                            </label>
                            <textarea 
                                id="gamePrompt" 
                                rows="4" 
                                class="w-full rounded-lg bg-gray-700 border-gray-600 text-white placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                                placeholder="Describe your dream game! Examples:
• Retro pixel art Snake game
• Physics-based puzzle platformer
• Space invaders with unique mechanics
• Interactive memory challenge"
                            ></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-cogs mr-2"></i>Game Complexity
                                </label>
                                <select 
                                    id="complexityLevel" 
                                    class="w-full rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                >
                                    <option value="basic">Basic</option>
                                    <option value="intermediate" selected>Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-palette mr-2"></i>Game Style
                                </label>
                                <select 
                                    id="gameStyle" 
                                    class="w-full rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                >
                                    <option value="minimal">Minimal</option>
                                    <option value="professional" selected>Professional</option>
                                    <option value="vibrant">Vibrant</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="bg-gray-800 rounded-lg p-4 h-full border border-gray-700">
                            <h3 class="text-xl font-semibold text-white mb-3">
                                <i class="fas fa-rocket mr-2"></i>Game Generation Tips
                            </h3>
                            <ul class="space-y-2 text-sm text-gray-300">
                                <li><i class="fas fa-check-circle mr-2 text-green-500"></i>Be specific about game mechanics</li>
                                <li><i class="fas fa-check-circle mr-2 text-green-500"></i>Describe core gameplay loop</li>
                                <li><i class="fas fa-check-circle mr-2 text-green-500"></i>Mention any unique twists</li>
                                <li><i class="fas fa-check-circle mr-2 text-green-500"></i>Consider player interactions</li>
                                <li><i class="fas fa-check-circle mr-2 text-green-500"></i>Think about visual style</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex space-x-4">
                    <button 
                        id="generateBtn" 
                        class="flex-1 bg-indigo-600 text-white py-4 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 font-semibold flex items-center justify-center space-x-3 transform hover:scale-105"
                    >
                        <i class="fas fa-magic mr-2"></i>
                        <span>Generate Game</span>
                    </button>
                    <button 
                        id="deleteGameBtn" 
                        class="bg-red-600 text-white py-4 px-6 rounded-lg hover:bg-red-700 transition duration-300 font-semibold flex items-center justify-center space-x-3 hidden transform hover:scale-105"
                    >
                        <i class="fas fa-trash-alt mr-2"></i>
                        <span>Delete Game</span>
                    </button>
                </div>

                <div id="loadingSpinner" class="mt-6 text-center hidden">
                    <div class="inline-block animate-spin w-16 h-16 border-[6px] border-current border-t-transparent text-indigo-600 rounded-full"></div>
                    <p class="mt-4 text-gray-300 text-lg">Generating your game...</p>
                </div>

                <div id="previewContainer" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-white">
                            <i class="fas fa-eye mr-2"></i>Game Preview
                        </h2>
                        <div class="flex space-x-3">
                            <button id="fullscreenBtn" class="text-indigo-300 hover:text-white transition duration-300 flex items-center bg-gray-800 px-3 py-2 rounded-lg">
                                <i class="fas fa-expand mr-2"></i>
                                Fullscreen
                            </button>
                            <button id="reloadGameBtn" class="text-green-300 hover:text-white transition duration-300 flex items-center bg-gray-800 px-3 py-2 rounded-lg">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Reload
                            </button>
                        </div>
                    </div>
                    <div id="gamePreview" class="bg-gray-800 rounded-lg p-4 min-h-[600px] relative border-2 border-gray-700 shadow-inner overflow-hidden">
                        <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-xl">
                            Game will appear here
                        </div>
                    </div>
                </div>

                <div id="codeContainer" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-white">
                            <i class="fas fa-code mr-2"></i>Game Source Code
                        </h2>
                        <div class="flex space-x-3">
                            <button id="copyCodeBtn" class="text-indigo-300 hover:text-white transition duration-300 flex items-center bg-gray-800 px-3 py-2 rounded-lg">
                                <i class="fas fa-copy mr-2"></i>
                                Copy Code
                            </button>
                            <button id="downloadCodeBtn" class="text-green-300 hover:text-white transition duration-300 flex items-center bg-gray-800 px-3 py-2 rounded-lg">
                                <i class="fas fa-download mr-2"></i>
                                Download
                            </button>
                        </div>
                    </div>
                    <pre class="rounded-lg max-h-[500px] overflow-auto"><code id="generatedCode" class="language-html"></code></pre>
                </div>
            </div>
        </div>
        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">
                <i class="fas fa-robot mr-2"></i>Gemini Model (Newest to Oldest)
            </label>
            <select 
                id="geminiModel" 
                class="w-full rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            >
                <option value="gemini-2.0-flash-exp" selected>Gemini 2.0 Flash (Experimental)</option>
                <option value="gemini-exp-1206">Gemini Experimental (1206)</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            </select>
        </div>
    </div>

    <script>
        // Placeholder Gemini API Key - replace with your own
        const GEMINI_API_KEY = 'AIzaSyAtIJNuqJsnifU3Ez3CNEtjUrhQWbB1N7o';
        
        async function checkProfanity(text) {
            const PROFANITY_API_ENDPOINT = 'https://www.purgomalum.com/service/containsprofanity';
            
            try {
                // Implement more robust error handling and timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5-second timeout
                
                const response = await fetch(`${PROFANITY_API_ENDPOINT}?text=${encodeURIComponent(text)}`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.warn('Profanity check service unavailable. Proceeding with generation.');
                    return false;
                }
                
                const result = await response.text();
                return result === 'true';
            } catch (error) {
                console.error('Profanity check error:', error);
                
                // More detailed error handling
                if (error.name === 'AbortError') {
                    console.warn('Profanity check timed out. Proceeding with generation.');
                }
                
                return false; // Default to safe if API fails
            }
        }

        // Enhanced game generation prompt
        function createDetailedPrompt(contextPrompt, complexity, style) {
    const complexityInstructions = {
        basic: 'Develop a straightforward tool or app with minimal features, simple logic, and intuitive interactions.',
        intermediate: 'Build an application with moderate complexity, incorporating multiple features, user state management, and responsive design.',
        advanced: 'Create a highly sophisticated app with advanced functionality, dynamic state handling, integrations, and extensive user interaction options.'
    };

    const styleInstructions = {
        minimal: 'Design a clean, minimalist interface with an emphasis on usability and clear, modern design elements.',
        vibrant: 'Use a visually engaging design with bold colors, playful animations, and an interactive user experience.',
        professional: 'Craft a sleek, professional aesthetic with a focus on functionality, subtle gradients, and polished UI components.'
    };

    return `Generate a complete, self-contained HTML5 application with these specifications:

ABSOLUTE REQUIREMENTS:
- ENTIRE application must be in ONE HTML file
- NO external dependencies (e.g., no external CSS or JS files)
- MUST run immediately in browser
- FULLY SELF-EXECUTABLE
- Cross-browser compatible
- Mobile-responsive
- Performance optimized

APPLICATION CONTEXT:
${contextPrompt}

COMPLEXITY STRATEGY: 
${complexityInstructions[complexity]}

VISUAL DESIGN:
${styleInstructions[style]}

IMPLEMENTATION GUIDELINES:
- Pure JavaScript implementation
- Efficient, modular, and readable code
- Error-resistant structure
- Responsive design for various screen sizes
- Avoid unnecessary global variables
- Use modern ES6+ features (e.g., arrow functions, classes, modules)
- Include robust error handling
- Prioritize user accessibility and experience
- Optimize for performance without compromising functionality

CRITICAL: Produce RAW, EXECUTABLE CODE without any additional explanatory text.`;
}

        // Utility function to handle API errors
        function handleApiError(error) {
            console.error('Game Generation Error:', error);
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // More detailed error logging and user feedback
            const errorDetails = {
                'network': 'Check your internet connection',
                'unauthorized': 'Invalid API credentials',
                'rate-limit': 'Too many requests. Please try again later',
                'service-unavailable': 'Game generation service is currently down'
            };
            
            // Determine error type based on error object or status
            const errorType = error.status === 429 ? 'rate-limit' :
                              error.status === 401 ? 'unauthorized' :
                              error.message.includes('network') ? 'network' : 
                              'service-unavailable';
            
            const errorMessage = document.createElement('div');
            errorMessage.innerHTML = `
                <div class="bg-red-600 text-white p-4 rounded-lg mt-4 animate-pulse">
                    <h3 class="font-bold mb-2">Game Generation Failed</h3>
                    <p>Error: ${errorDetails[errorType]}</p>
                    <small class="mt-2 block">Technical details: ${sanitizeHTML(error.message)}</small>
                    <div class="mt-3 text-sm">
                        <strong>Troubleshooting Tips:</strong>
                        <ul class="list-disc pl-5">
                            ${errorType === 'network' ? '<li>Check your internet connection</li>' : ''}
                            ${errorType === 'unauthorized' ? '<li>Verify your API key</li>' : ''}
                            <li>Refresh the page and try again</li>
                        </ul>
                    </div>
                </div>
            `;
            
            loadingSpinner.innerHTML = '';
            loadingSpinner.appendChild(errorMessage);
        }

        // Safe HTML sanitization to prevent XSS
        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            
            // Additional sanitization steps
            const sanitizedContent = div.innerHTML
                .replace(/</g, '&lt;')   // Escape < character
                .replace(/>/g, '&gt;')   // Escape > character
                .replace(/"/g, '&quot;') // Escape double quotes
                .replace(/'/g, '&#39;')  // Escape single quotes
                .replace(/&/g, '&amp;'); // Escape ampersand
            
            return sanitizedContent;
        }
        
        // Add this function to the existing script, just before the 'Game generation event listener'

        async function improveGeneratedGame(originalCode, gamePrompt, complexityLevel, gameStyle) {
            const improvementPrompt = `Review and improve the following HTML game code. Identify and fix:
            1. Any potential bugs or performance issues
            2. Cross-browser compatibility problems
            3. Accessibility improvements
            4. Code readability and efficiency
            5. Responsive design enhancements
        
            CONTEXT:
            Original Game Concept: ${gamePrompt}
            Complexity Level: ${complexityLevel}
            Design Style: ${gameStyle}
        
            IMPROVEMENT GUIDELINES:
            - Maintain the EXACT same structure (ONE HTML file, no external dependencies)
            - Preserve the core game mechanics
            - Use modern JavaScript best practices
            - Enhance and use modern CSS best practices and design practices
            - Enhance code quality without changing fundamental functionality
            - Optimize performance, and make it more efficient whilst following best practices
            - Fix any bugs you find in the HTML file, and follow best practices
        
            ORIGINAL CODE:
            ${originalCode}
        
            CRITICAL: Produce RAW, EXECUTABLE CODE without any additional explanatory text.`;
            
            const geminiModel = document.getElementById('geminiModel').value;
            const modelNames = {
                'gemini-2.0-flash-exp': 'Gemini 2.0 Flash Experimental',
                'gemini-1.5-flash': 'Gemini 1.5 Flash',
                'gemini-exp-1206': 'Gemini Experimental 1206',
            };
            
            loadingSpinner.querySelector('p').textContent = `${modelNames[geminiModel]} is refining your code...`;
        
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': GEMINI_API_KEY
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: improvementPrompt
                            }]
                        }]
                    })
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                const improvedGameCode = data.candidates[0].content.parts[0].text
                    .replace(/```html/g, '')
                    .replace(/```/g, '')
                    .trim();
        
                return improvedGameCode;
            } catch (error) {
                console.error('Game Improvement Error:', error);
                return null;
            }
        }

        // Game generation event listener
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const gamePrompt = document.getElementById('gamePrompt').value;
            const complexityLevel = document.getElementById('complexityLevel').value;
            const gameStyle = document.getElementById('gameStyle').value;
            const geminiModel = document.getElementById('geminiModel').value;
            const loadingSpinner = document.getElementById('loadingSpinner');
            const previewContainer = document.getElementById('previewContainer');
            const codeContainer = document.getElementById('codeContainer');
            const gamePreview = document.getElementById('gamePreview');
            const generatedCodeElement = document.getElementById('generatedCode');
            const deleteGameBtn = document.getElementById('deleteGameBtn');
        
            // Input validation
            if (!gamePrompt.trim()) {
                alert('Please describe your game concept!');
                return;
            }

            // Profanity check
            try {
                const hasProfanity = await checkProfanity(gamePrompt);
                if (hasProfanity) {
                    alert('Your game description contains inappropriate language. Please revise.');
                    return;
                }
            } catch (error) {
                console.error('Profanity check failed:', error);
                // Optionally proceed or stop based on your preference
            }
        
            // Reset UI
            loadingSpinner.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            codeContainer.classList.add('hidden');
            gamePreview.innerHTML = '';
        
            try {
                const detailedPrompt = createDetailedPrompt(gamePrompt, complexityLevel, gameStyle);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': GEMINI_API_KEY
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: detailedPrompt
                            }]
                        }]
                    })
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                let gameCode = data.candidates[0].content.parts[0].text
                    .replace(/```html/g, '')
                    .replace(/```/g, '')
                    .trim();
        
                const modelNames = {
                    'gemini-2.0-flash-exp': 'Gemini 2.0 Flash (Experimental)',
                    'gemini-1.5-flash': 'Gemini 1.5 Flash',
                    'gemini-exp-1206': 'Gemini Experimental 1206',
                };

                loadingSpinner.querySelector('p').textContent = `${modelNames[geminiModel]} is generating your game...`;
                const improvedGameCode = await improveGeneratedGame(gameCode, gamePrompt, complexityLevel, gameStyle);
                
                // Use improved code if successfully generated
                if (improvedGameCode) {
                    gameCode = improvedGameCode;
                }
        
                // Beautify HTML for readability
                const beautifiedCode = html_beautify(gameCode, {
                    indent_size: 2,
                    wrap_line_length: 80
                });
        
                // Create game iframe
                const gameFrame = document.createElement('iframe');
                gameFrame.id = 'gameFrame';
                gameFrame.srcdoc = gameCode;
                gameFrame.style.width = '100%';
                gameFrame.style.height = '100%';
                gameFrame.style.border = 'none';
                gameFrame.style.position = 'absolute';
                gameFrame.style.top = '0';
                gameFrame.style.left = '0';
        
                gamePreview.innerHTML = '';
                gamePreview.appendChild(gameFrame);
        
                // Syntax highlighting and code display
                generatedCodeElement.textContent = beautifiedCode;
                Prism.highlightElement(generatedCodeElement);
        
                // Update UI
                loadingSpinner.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                codeContainer.classList.remove('hidden');
                deleteGameBtn.classList.remove('hidden');
        
            } catch (error) {
                handleApiError(error);
            }
        });

        // Delete game functionality
        document.getElementById('deleteGameBtn').addEventListener('click', () => {
            const gamePreview = document.getElementById('gamePreview');
            const previewContainer = document.getElementById('previewContainer');
            const codeContainer = document.getElementById('codeContainer');
            const deleteGameBtn = document.getElementById('deleteGameBtn');

            gamePreview.innerHTML = `
                <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-xl">
                    Game will appear here
                </div>
            `;
            previewContainer.classList.add('hidden');
            codeContainer.classList.add('hidden');
            deleteGameBtn.classList.add('hidden');
        });

        // Fullscreen game preview
        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            const gameFrame = document.getElementById('gameFrame');
            
            if (gameFrame) {
                if (gameFrame.requestFullscreen) {
                    gameFrame.requestFullscreen();
                } else if (gameFrame.mozRequestFullScreen) {
                    gameFrame.mozRequestFullScreen();
                } else if (gameFrame.webkitRequestFullscreen) {
                    gameFrame.webkitRequestFullscreen();
                } else if (gameFrame.msRequestFullscreen) {
                    gameFrame.msRequestFullscreen();
                }
            }
        });

        // Reload game functionality
        document.getElementById('reloadGameBtn').addEventListener('click', () => {
            const gameFrame = document.getElementById('gameFrame');
            if (gameFrame) {
                gameFrame.contentWindow.location.reload();
            }
        });

        // Copy code to clipboard
        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            const generatedCodeElement = document.getElementById('generatedCode');
            const copyBtn = document.getElementById('copyCodeBtn');
            
            navigator.clipboard.writeText(generatedCodeElement.textContent).then(() => {
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Copied!
                `;
                
                setTimeout(() => {
                    copyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Copy Code
                    `;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Copy Failed
                `;
                
                setTimeout(() => {
                    copyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Copy Code
                    `;
                }, 2000);
            });
        });

        // Download game code
        document.getElementById('downloadCodeBtn').addEventListener('click', () => {
            const generatedCodeElement = document.getElementById('generatedCode');
            const gameCode = generatedCodeElement.textContent;
            const blob = new Blob([gameCode], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'generated_game.html';
            link.click();
        });
    </script>
</body>
</html>
