<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>dupuis TV</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
  />

  <style>
    /* Overlays */
    #activeQuestion {
      background-color: rgba(0, 123, 255, 0.95);
      color: white;
      z-index: 1001;
    }
    #upcomingNotification {
      background-color: rgba(255, 193, 7, 0.9);
      color: #856404;
      z-index: 1002;
    }

    .dark .dark-mode-bg {
      background-color: #1a1a1a !important;
      color: #f4f4f4 !important;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 transition-colors duration-300">
  <div class="container mx-auto dark-mode-bg transition-colors duration-300">
    
    <!-- Dark Mode Toggle -->
    <div class="flex justify-end mb-4">
      <label class="inline-flex items-center cursor-pointer">
        <span class="mr-2 font-semibold">Dark Mode</span>
        <input type="checkbox" id="darkModeToggle" class="hidden" />
        <div
          class="w-10 h-5 bg-gray-300 rounded-full p-1 flex items-center"
          id="darkModeSwitch"
        >
          <div class="bg-white w-4 h-4 rounded-full shadow transform transition-transform duration-300"></div>
        </div>
      </label>
    </div>

    <h1 class="text-3xl font-bold text-center text-blue-600 mb-6 dark:text-blue-400">
      <i class="fas fa-video"></i> dupuis TV
    </h1>

    <!-- Video Upload Section -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-6 dark:bg-gray-800 dark:text-gray-100">
      <h2 class="text-xl font-semibold mb-4">
        <i class="fas fa-upload"></i> Upload Video
      </h2>
      <input 
        type="file" 
        id="videoUpload" 
        accept="video/*" 
        class="block w-full text-sm text-gray-500
               file:mr-4 file:py-2 file:px-4
               file:rounded file:border-0
               file:text-sm file:font-semibold
               file:bg-blue-500 file:text-white
               hover:file:bg-blue-600 dark:text-gray-200"
      />
      <p class="text-gray-500 text-sm mt-2 dark:text-gray-400">
        Select a video file to upload.
      </p>
    </div>

    <!-- Video Player Section -->
    <div 
      class="bg-white shadow-md rounded-lg p-6 mb-6 hidden dark:bg-gray-800 dark:text-gray-100"
      id="videoCard"
    >
      <div class="flex flex-wrap justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">
          <i class="fas fa-play-circle"></i> Video Player
        </h2>
        <div class="flex flex-wrap gap-2 mt-2 md:mt-0">
          <button
            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center"
            onclick="openAddQuestionModal()"
          >
            <i class="fas fa-plus mr-2"></i> Add Question
          </button>
          <!-- NEW: Quick Add MCQ -->
          <button
            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center"
            onclick="openQuickAddModal()"
          >
            <i class="fas fa-bolt mr-2"></i> Quick Add MCQ
          </button>
          <button
            class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 flex items-center"
            onclick="resetData()"
          >
            <i class="fas fa-trash-alt mr-2"></i> Reset All
          </button>
          <button
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center"
            onclick="exportQuestions()"
          >
            <i class="fas fa-file-export mr-2"></i> Export
          </button>
          <button
            class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 flex items-center"
            onclick="openImportModal()"
          >
            <i class="fas fa-file-import mr-2"></i> Import
          </button>
          <!-- NEW: Bulk CSV Import -->
          <button
            class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 flex items-center"
            onclick="openCSVModal()"
          >
            <i class="fas fa-file-csv mr-2"></i> Bulk CSV
          </button>
        </div>
      </div>

      <div class="relative">
        <video id="videoPlayer" class="w-full rounded" controls></video>

        <!-- Active Question Overlay -->
        <div id="activeQuestion" class="hidden absolute inset-0 flex items-center justify-center p-4 dark:text-gray-900">
          <div class="bg-white text-gray-800 p-6 rounded shadow-lg w-full max-w-md">
            <h3 class="text-lg font-bold mb-2" id="questionText">Question Text</h3>
            <p class="text-xs text-gray-500 mb-4" id="timerText"></p>
            <div id="questionOptions" class="mb-4"></div>
            <div id="feedback" class="mb-4"></div>
            <div id="explanation" class="text-sm text-gray-600 mb-4"></div>
            <div class="flex space-x-2">
              <button 
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                onclick="submitAnswer()"
                id="submitAnswerBtn"
              >
                Submit
              </button>
              <button 
                class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 hidden"
                onclick="skipQuestion()"
                id="skipBtn"
              >
                Skip
              </button>
              <button 
                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                onclick="closeQuestion()"
              >
                Close
              </button>
            </div>
          </div>
        </div>

        <!-- Upcoming Question Notification -->
        <div 
          id="upcomingNotification"
          class="hidden absolute top-0 left-1/2 transform -translate-x-1/2 mt-2 px-4 py-2 rounded shadow-lg"
        >
          <span class="font-semibold">
            <i class="fas fa-info-circle"></i> A question will appear in
            <span id="countdown">5</span> seconds.
          </span>
        </div>
      </div>

      <!-- Scoreboard -->
      <div class="mt-4 p-4 bg-gray-50 rounded-md flex items-center justify-between dark:bg-gray-700 dark:text-gray-100">
        <div class="flex items-center">
          <i class="fas fa-trophy text-yellow-500 mr-2"></i>
          <span class="font-semibold">Score: </span>
          <span id="scoreText" class="ml-1">0</span> / <span id="totalQuestions" class="ml-1">0</span>
        </div>
        <div class="flex items-center text-sm text-gray-600 dark:text-gray-200">
          <span class="mr-2">Correct:</span>
          <span id="correctCount">0</span>
          <span class="mx-2">|</span>
          <span class="mr-2">Incorrect:</span>
          <span id="incorrectCount">0</span>
        </div>
      </div>

      <!-- Question Filters & List -->
      <div class="mt-4">
        <!-- Filters -->
        <div class="flex flex-wrap items-center gap-2 mb-2">
          <input
            type="text"
            id="searchInput"
            placeholder="Search questions..."
            class="border border-gray-300 rounded p-2 dark:bg-gray-600 dark:text-gray-200"
            oninput="filterQuestions()"
          />
          <select
            id="filterType"
            class="border border-gray-300 rounded p-2 dark:bg-gray-600 dark:text-gray-200"
            onchange="filterQuestions()"
          >
            <option value="">All Types</option>
            <option value="multiple_choice">Multiple Choice</option>
            <option value="fill_in_blank">Fill in the Blank</option>
            <option value="true_false">True/False</option>
            <option value="short_answer">Short Answer</option>
          </select>
          <select
            id="filterDifficulty"
            class="border border-gray-300 rounded p-2 dark:bg-gray-600 dark:text-gray-200"
            onchange="filterQuestions()"
          >
            <option value="">All Difficulties</option>
            <option value="Easy">Easy</option>
            <option value="Medium">Medium</option>
            <option value="Hard">Hard</option>
          </select>
        </div>

        <h3 class="text-lg font-semibold mb-2">Questions List</h3>
        <ul class="max-h-48 overflow-y-auto" id="questionList">
          <!-- Dynamically populated questions -->
        </ul>
      </div>

      <!-- Upcoming Questions -->
      <div class="mt-4">
        <h3 class="text-lg font-semibold mb-2">Upcoming Questions</h3>
        <ul class="max-h-32 overflow-y-auto text-gray-700 dark:text-gray-200" id="upcomingQuestionsList">
          <!-- Dynamically populated upcoming questions -->
        </ul>
      </div>
    </div>

    <!-- Add/Edit Question Modal -->
    <div id="addQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative dark:bg-gray-800 dark:text-gray-100">
        <button
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:text-gray-300"
          onclick="closeAddQuestionModal()"
          aria-label="Close Modal"
        >
          <i class="fas fa-times"></i>
        </button>
        <h2 class="text-2xl font-semibold mb-4" id="modalTitle">
          <i class="fas fa-question-circle"></i> Add New Question
        </h2>
        <form id="questionForm" class="space-y-4">
          <input type="hidden" id="editIndex" value="" />

          <!-- Question Type -->
          <div>
            <label for="questionType" class="block text-sm font-medium">
              Question Type
            </label>
            <select
              id="questionType"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-100"
              required
            >
              <option value="" disabled selected>Select type</option>
              <option value="multiple_choice">Multiple Choice</option>
              <option value="fill_in_blank">Fill in the Blank</option>
              <option value="true_false">True/False</option>
              <option value="short_answer">Short Answer</option>
            </select>
          </div>

          <!-- Difficulty -->
          <div>
            <label for="difficulty" class="block text-sm font-medium">
              Difficulty (optional)
            </label>
            <select
              id="difficulty"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-100"
            >
              <option value="">Select difficulty</option>
              <option value="Easy">Easy</option>
              <option value="Medium">Medium</option>
              <option value="Hard">Hard</option>
            </select>
          </div>

          <!-- Question Text -->
          <div>
            <label for="questionTextInput" class="block text-sm font-medium">
              Question
            </label>
            <input
              type="text"
              id="questionTextInput"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-100"
              required
            />
          </div>

          <!-- Options Container -->
          <div id="optionsContainer" class="hidden">
            <label class="block text-sm font-medium">Options</label>
            <div class="space-y-2 mt-2">
              <div class="flex items-center">
                <input type="radio" name="correctOption" value="A" class="mr-2" />
                <span class="w-6 text-center">A.</span>
                <input
                  type="text"
                  class="flex-1 border-gray-300 rounded-md shadow-sm ml-2 option-input dark:bg-gray-700 dark:text-gray-100"
                  placeholder="Option A"
                  required
                />
              </div>
              <div class="flex items-center">
                <input type="radio" name="correctOption" value="B" class="mr-2" />
                <span class="w-6 text-center">B.</span>
                <input
                  type="text"
                  class="flex-1 border-gray-300 rounded-md shadow-sm ml-2 option-input dark:bg-gray-700 dark:text-gray-100"
                  placeholder="Option B"
                  required
                />
              </div>
              <div class="flex items-center">
                <input type="radio" name="correctOption" value="C" class="mr-2" />
                <span class="w-6 text-center">C.</span>
                <input
                  type="text"
                  class="flex-1 border-gray-300 rounded-md shadow-sm ml-2 option-input dark:bg-gray-700 dark:text-gray-100"
                  placeholder="Option C"
                />
              </div>
              <div class="flex items-center">
                <input type="radio" name="correctOption" value="D" class="mr-2" />
                <span class="w-6 text-center">D.</span>
                <input
                  type="text"
                  class="flex-1 border-gray-300 rounded-md shadow-sm ml-2 option-input dark:bg-gray-700 dark:text-gray-100"
                  placeholder="Option D"
                />
              </div>
            </div>
          </div>

          <!-- Correct Answer -->
          <div id="correctAnswerContainer">
            <label for="correctAnswer" class="block text-sm font-medium">
              Correct Answer
            </label>
            <input
              type="text"
              id="correctAnswer"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-100"
              required
            />
            <p class="text-xs text-gray-500 mt-1">
              For Multiple Choice and True/False, select the correct option instead.
            </p>
          </div>

          <!-- Explanation (optional) -->
          <div>
            <label for="explanationInput" class="block text-sm font-medium">
              Explanation (optional)
            </label>
            <textarea
              id="explanationInput"
              rows="2"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-100"
              placeholder="Explain the correct answer..."
            ></textarea>
          </div>

          <!-- Timestamp -->
          <div>
            <label for="timestamp" class="block text-sm font-medium">
              Timestamp (in seconds)
            </label>
            <input
              type="number"
              id="timestamp"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-100"
              min="0"
              required
            />
          </div>

          <!-- Question Timer (seconds to answer) -->
          <div>
            <label for="questionTimer" class="block text-sm font-medium">
              Timer for this Question (seconds, optional)
            </label>
            <input
              type="number"
              id="questionTimer"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-100"
              min="0"
              placeholder="e.g., 10 (0 = no timer)"
            />
            <p class="text-xs text-gray-500 mt-1">
              If set, user must answer before time runs out, or question is marked incorrect.
            </p>
          </div>

          <!-- Allow Skip? -->
          <div class="flex items-center">
            <input
              type="checkbox"
              id="allowSkip"
              class="mr-2"
            />
            <label for="allowSkip" class="text-sm font-medium">
              Allow user to skip this question
            </label>
          </div>

          <!-- Submit -->
          <div class="flex justify-end">
            <button
              type="submit"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center"
            >
              <i class="fas fa-save mr-2"></i> Save Question
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- QUICK ADD MCQ Modal -->
    <div id="quickAddModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative dark:bg-gray-800 dark:text-gray-100">
        <button
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:text-gray-300"
          onclick="closeQuickAddModal()"
          aria-label="Close Modal"
        >
          <i class="fas fa-times"></i>
        </button>
        <h2 class="text-xl font-semibold mb-4">
          <i class="fas fa-bolt"></i> Quick Add MCQ
        </h2>
        <form id="quickAddForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium">Question Text</label>
            <input
              type="text"
              id="quickQuestionText"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-100"
              required
            />
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium">Options</label>
            <div class="flex items-center">
              <input type="radio" name="quickCorrectOption" value="A" class="mr-2" />
              <input
                type="text"
                id="quickOptionA"
                class="flex-1 border-gray-300 rounded-md shadow-sm p-2 dark:bg-gray-700 dark:text-gray-100"
                placeholder="Option A"
                required
              />
            </div>
            <div class="flex items-center">
              <input type="radio" name="quickCorrectOption" value="B" class="mr-2" />
              <input
                type="text"
                id="quickOptionB"
                class="flex-1 border-gray-300 rounded-md shadow-sm p-2 dark:bg-gray-700 dark:text-gray-100"
                placeholder="Option B"
                required
              />
            </div>
            <div class="flex items-center">
              <input type="radio" name="quickCorrectOption" value="C" class="mr-2" />
              <input
                type="text"
                id="quickOptionC"
                class="flex-1 border-gray-300 rounded-md shadow-sm p-2 dark:bg-gray-700 dark:text-gray-100"
                placeholder="Option C"
              />
            </div>
            <div class="flex items-center">
              <input type="radio" name="quickCorrectOption" value="D" class="mr-2" />
              <input
                type="text"
                id="quickOptionD"
                class="flex-1 border-gray-300 rounded-md shadow-sm p-2 dark:bg-gray-700 dark:text-gray-100"
                placeholder="Option D"
              />
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium">
              Timestamp (in seconds)
            </label>
            <input
              type="number"
              id="quickTimestamp"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:text-gray-100"
              min="0"
              required
            />
          </div>
          <div class="flex justify-end">
            <button
              type="submit"
              class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center"
            >
              <i class="fas fa-save mr-2"></i> Quick Add
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Import Questions Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative dark:bg-gray-800 dark:text-gray-100">
        <button
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:text-gray-300"
          onclick="closeImportModal()"
          aria-label="Close Modal"
        >
          <i class="fas fa-times"></i>
        </button>
        <h2 class="text-2xl font-semibold mb-4">
          <i class="fas fa-file-import"></i> Import Questions
        </h2>
        <form id="importForm" class="space-y-4">
          <div>
            <label for="importFile" class="block text-sm font-medium">
              Select JSON File
            </label>
            <input
              type="file"
              id="importFile"
              accept=".json"
              class="mt-1 block w-full text-sm text-gray-500
                     file:mr-4 file:py-2 file:px-4
                     file:rounded file:border-0
                     file:text-sm file:font-semibold
                     file:bg-purple-500 file:text-white
                     hover:file:bg-purple-600 dark:text-gray-200"
              required
            />
          </div>
          <div class="flex justify-end">
            <button
              type="submit"
              class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 flex items-center"
            >
              <i class="fas fa-upload mr-2"></i> Import
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- NEW: Bulk CSV Modal -->
    <div id="csvModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative dark:bg-gray-800 dark:text-gray-100">
        <button
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:text-gray-300"
          onclick="closeCSVModal()"
          aria-label="Close Modal"
        >
          <i class="fas fa-times"></i>
        </button>
        <h2 class="text-2xl font-semibold mb-4">
          <i class="fas fa-file-csv"></i> Bulk Add from CSV
        </h2>
        <form id="csvForm" class="space-y-4">
          <div>
            <label for="csvFile" class="block text-sm font-medium">
              Select CSV File
            </label>
            <input
              type="file"
              id="csvFile"
              accept=".csv"
              class="mt-1 block w-full text-sm text-gray-500
                     file:mr-4 file:py-2 file:px-4
                     file:rounded file:border-0
                     file:text-sm file:font-semibold
                     file:bg-yellow-600 file:text-white
                     hover:file:bg-yellow-700 dark:text-gray-200"
              required
            />
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-300">
            Format: <br/>
            question_text,optionA,optionB,optionC,optionD,correctOption,timestamp
          </p>
          <div class="flex justify-end">
            <button
              type="submit"
              class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 flex items-center"
            >
              <i class="fas fa-upload mr-2"></i> Import CSV
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- End-of-Video Summary Modal -->
    <div id="endSummaryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-6 relative dark:bg-gray-800 dark:text-gray-100">
        <button
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:text-gray-300"
          onclick="closeEndSummaryModal()"
          aria-label="Close Modal"
        >
          <i class="fas fa-times"></i>
        </button>
        <h2 class="text-2xl font-semibold mb-4">
          <i class="fas fa-check-circle"></i> Video Completed
        </h2>
        <p class="mb-4">
          Congratulations, you've reached the end of the video! Here is a summary of your performance:
        </p>
        <div class="mb-4 border border-gray-200 rounded p-4 dark:border-gray-700">
          <p><strong>Total Questions:</strong> <span id="endTotalQuestions">0</span></p>
          <p><strong>Correct Answers:</strong> <span id="endCorrectAnswers">0</span></p>
          <p><strong>Incorrect Answers:</strong> <span id="endIncorrectAnswers">0</span></p>
        </div>
        <h3 class="text-xl font-semibold mb-2">Review:</h3>
        <ul id="endReviewList" class="space-y-2">
          <!-- Each question with correct or incorrect status -->
        </ul>
        <div class="flex justify-end mt-4">
          <button
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center"
            onclick="closeEndSummaryModal()"
          >
            Close
          </button>
        </div>
      </div>
    </div>

  </div>
  
  <!-- JavaScript -->
  <script>
    // Elements
    const body                  = document.body;
    const darkModeToggle        = document.getElementById('darkModeToggle');
    const darkModeSwitch        = document.getElementById('darkModeSwitch');
    const videoUpload           = document.getElementById('videoUpload');
    const videoCard             = document.getElementById('videoCard');
    const videoPlayer           = document.getElementById('videoPlayer');
    
    const addQuestionModal      = document.getElementById('addQuestionModal');
    const quickAddModal         = document.getElementById('quickAddModal');
    const importModal           = document.getElementById('importModal');
    const csvModal              = document.getElementById('csvModal');
    const endSummaryModal       = document.getElementById('endSummaryModal');

    const questionType          = document.getElementById('questionType');
    const optionsContainer      = document.getElementById('optionsContainer');
    const correctAnswerContainer= document.getElementById('correctAnswerContainer');
    const questionForm          = document.getElementById('questionForm');
    const quickAddForm          = document.getElementById('quickAddForm');
    const questionList          = document.getElementById('questionList');
    const upcomingQuestionsList = document.getElementById('upcomingQuestionsList');
    const activeQuestion        = document.getElementById('activeQuestion');
    const questionText          = document.getElementById('questionText');
    const questionOptions       = document.getElementById('questionOptions');
    const feedback              = document.getElementById('feedback');
    const explanationDiv        = document.getElementById('explanation');
    const modalTitle            = document.getElementById('modalTitle');
    const editIndexInput        = document.getElementById('editIndex');
    const upcomingNotification  = document.getElementById('upcomingNotification');
    const countdownElement      = document.getElementById('countdown');

    const importForm            = document.getElementById('importForm');
    const importFile            = document.getElementById('importFile');
    const csvForm               = document.getElementById('csvForm');
    const csvFile               = document.getElementById('csvFile');

    const difficultySelect      = document.getElementById('difficulty');
    const searchInput           = document.getElementById('searchInput');
    const filterTypeSelect      = document.getElementById('filterType');
    const filterDifficulty      = document.getElementById('filterDifficulty');

    // Additional form elements
    const allowSkipCheckbox     = document.getElementById('allowSkip');
    const questionTimerInput    = document.getElementById('questionTimer');

    // Scoreboard elements
    const scoreText        = document.getElementById('scoreText');
    const totalQuestionsEl = document.getElementById('totalQuestions');
    const correctCountEl   = document.getElementById('correctCount');
    const incorrectCountEl = document.getElementById('incorrectCount');
    const endTotalQsEl     = document.getElementById('endTotalQuestions');
    const endCorrectEl     = document.getElementById('endCorrectAnswers');
    const endIncorrectEl   = document.getElementById('endIncorrectAnswers');
    const endReviewList    = document.getElementById('endReviewList');

    // Timer display
    const timerText              = document.getElementById('timerText');
    let questionCountdownInterval= null;

    // Buttons
    const submitAnswerBtn        = document.getElementById('submitAnswerBtn');
    const skipBtn                = document.getElementById('skipBtn');

    // Data
    let questions = [];
    let currentQuestionIndex = null;

    // Score tracking
    let correctAnswersCount   = 0;
    let incorrectAnswersCount = 0;

    // Configuration
    let shuffleMultipleChoiceOptions = true; // You can disable if you don't want shuffling
    let enableQuestionRetake        = false; // If you want user re-attempt logic, set true, then handle logic
    // (For simplicity, we’ll keep it off here)

    // Active question data in memory
    let activeQuestionData = null;  
    let userHasAttempted   = false;  

    // For notifications
    let countdownTimer   = null;
    let countdownInterval= null;

    // Load from localStorage
    window.onload = () => {
      const savedVideo          = localStorage.getItem('uploadedVideo');
      const savedQuestions      = localStorage.getItem('questions');
      const savedCorrectCount   = localStorage.getItem('correctCount');
      const savedIncorrectCount = localStorage.getItem('incorrectCount');
      const savedDarkMode       = localStorage.getItem('darkMode') === 'true';

      // Dark Mode
      darkModeToggle.checked = savedDarkMode;
      handleDarkModeToggle();

      if (savedVideo) {
        videoPlayer.src = savedVideo;
        videoCard.classList.remove('hidden');
      }
      if (savedQuestions) {
        questions = JSON.parse(savedQuestions);
      }
      if (savedCorrectCount) {
        correctAnswersCount = parseInt(savedCorrectCount, 10);
      }
      if (savedIncorrectCount) {
        incorrectAnswersCount = parseInt(savedIncorrectCount, 10);
      }
      renderAll();

      // Event: Check if video ended -> show summary
      videoPlayer.addEventListener('ended', onVideoEnded);
    };

    // Dark Mode Toggle Handler
    darkModeToggle.addEventListener('change', handleDarkModeToggle);
    function handleDarkModeToggle() {
      const isDark = darkModeToggle.checked;
      localStorage.setItem('darkMode', isDark);
      if (isDark) {
        body.classList.add('dark');
      } else {
        body.classList.remove('dark');
      }
      moveSwitchKnob(isDark);
    }
    function moveSwitchKnob(isDark) {
      const knob = darkModeSwitch.querySelector('div');
      if (isDark) {
        knob.style.transform = 'translateX(1.25rem)'; // Move to right
        darkModeSwitch.classList.remove('bg-gray-300');
        darkModeSwitch.classList.add('bg-blue-600');
      } else {
        knob.style.transform = 'translateX(0rem)'; // Move to left
        darkModeSwitch.classList.add('bg-gray-300');
        darkModeSwitch.classList.remove('bg-blue-600');
      }
    }

    // Video Upload Handler
    videoUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const videoURL = URL.createObjectURL(file);
        videoPlayer.src = videoURL;
        videoCard.classList.remove('hidden');
        localStorage.setItem('uploadedVideo', videoURL);

        // Reset displayed/notified flags
        questions.forEach(q => {
          q.displayed = false;
          q.notified = false;
          q.answered = false;
        });
        saveQuestions();
        renderAll();
      }
    });

    // Show/Hide Options based on Question Type
    questionType.addEventListener('change', (e) => {
      handleQuestionTypeUI(e.target.value);
    });

    function handleQuestionTypeUI(type) {
      if (type === 'multiple_choice' || type === 'true_false') {
        optionsContainer.classList.remove('hidden');
        correctAnswerContainer.classList.add('hidden');
        document.querySelectorAll('.option-input').forEach(input => (input.required = (type === 'multiple_choice')));
        if (type === 'true_false') {
          const optionInputs = document.querySelectorAll('.option-input');
          optionInputs[0].value = 'True';
          optionInputs[1].value = 'False';
          optionInputs[2].value = '';
          optionInputs[3].value = '';
        }
      } else {
        optionsContainer.classList.add('hidden');
        correctAnswerContainer.classList.remove('hidden');
        document.querySelectorAll('.option-input').forEach(input => {
          input.required = false;
          input.value = '';
        });
      }
    }

    // Handle Question Form Submission
    questionForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const type          = questionType.value;
      const diff          = difficultySelect.value;
      const text          = document.getElementById('questionTextInput').value.trim();
      const explanation   = document.getElementById('explanationInput').value.trim();
      let timestamp       = parseFloat(document.getElementById('timestamp').value);
      const editIndex     = editIndexInput.value;
      const timeLimit     = parseInt(questionTimerInput.value || '0', 10);
      const allowSkip     = allowSkipCheckbox.checked;

      if (timestamp < 0) {
        alert('Timestamp cannot be negative.');
        return;
      }

      // Validate that timestamp is within video duration if video is loaded
      if (videoPlayer.duration && timestamp > videoPlayer.duration) {
        if (!confirm('Timestamp exceeds video duration. Snap to video end?')) {
          return;
        } else {
          timestamp = Math.floor(videoPlayer.duration) - 1;
        }
      }

      let options = [];
      let correctAnswer = '';
      if (type === 'multiple_choice' || type === 'true_false') {
        options = Array.from(document.querySelectorAll('.option-input'))
          .map(input => input.value)
          .filter(val => val);
        const selectedOption = document.querySelector('input[name="correctOption"]:checked');
        if (selectedOption) {
          correctAnswer = selectedOption.value;
        } else {
          alert('Please select the correct answer.');
          return;
        }
      } else {
        correctAnswer = document.getElementById('correctAnswer').value.trim();
        if (!correctAnswer) {
          alert('Please enter the correct answer.');
          return;
        }
        if (type === 'multiple_choice' || type === 'true_false') {
          correctAnswer = correctAnswer.toUpperCase();
        }
      }

      const newQuestion = {
        type,
        difficulty: diff,
        text,
        options,
        correctAnswer,
        explanation,
        timestamp,
        timeLimit,
        allowSkip,
        displayed: false,
        notified: false,
        answered: false
      };

      if (editIndex === '') {
        questions.push(newQuestion);
      } else {
        questions[editIndex] = { ...newQuestion };
      }

      saveQuestions();
      closeAddQuestionModal();
      renderAll();
      alert('Question saved successfully!');
    });

    // QUICK ADD MCQ
    quickAddForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const text          = document.getElementById('quickQuestionText').value.trim();
      const optionA       = document.getElementById('quickOptionA').value.trim();
      const optionB       = document.getElementById('quickOptionB').value.trim();
      const optionC       = document.getElementById('quickOptionC').value.trim();
      const optionD       = document.getElementById('quickOptionD').value.trim();
      let correctOption   = document.querySelector('input[name="quickCorrectOption"]:checked');
      let timestamp       = parseFloat(document.getElementById('quickTimestamp').value);

      if (!correctOption) {
        alert('Please select the correct option.');
        return;
      }
      correctOption = correctOption.value.toUpperCase();

      if (!['A','B','C','D'].includes(correctOption)) {
        alert('Correct option must be A, B, C, or D.');
        return;
      }

      if (timestamp < 0) {
        alert('Timestamp cannot be negative.');
        return;
      }
      if (videoPlayer.duration && timestamp > videoPlayer.duration) {
        if (!confirm('Timestamp exceeds video duration. Snap to video end?')) {
          return;
        } else {
          timestamp = Math.floor(videoPlayer.duration) - 1;
        }
      }

      const options = [optionA, optionB, optionC, optionD].filter(o => o);
      if (options.length < 2) {
        alert('Please provide at least two options.');
        return;
      }

      const newMCQ = {
        type: 'multiple_choice',
        difficulty: '',
        text,
        options,
        correctAnswer: correctOption,
        explanation: '',
        timestamp,
        timeLimit: 0,
        allowSkip: false,
        displayed: false,
        notified: false,
        answered: false
      };

      questions.push(newMCQ);
      saveQuestions();
      closeQuickAddModal();
      renderAll();
      alert('MCQ added successfully!');
    });

    // Render All UI Components
    function renderAll() {
      renderQuestionList();
      renderUpcomingQuestions();
      updateScoreboard();
    }

    // Render Questions List
    function renderQuestionList() {
      questionList.innerHTML = '';
      if (questions.length === 0) {
        const li = document.createElement('li');
        li.className = 'text-gray-500';
        li.textContent = 'No questions added yet.';
        questionList.appendChild(li);
        totalQuestionsEl.textContent = '0';
        return;
      }
      questions.sort((a, b) => a.timestamp - b.timestamp);

      // Apply filters
      const filteredQuestions = applyFilters(questions);

      if (filteredQuestions.length === 0) {
        const li = document.createElement('li');
        li.className = 'text-gray-500';
        li.textContent = 'No questions match your filters/search.';
        questionList.appendChild(li);
        totalQuestionsEl.textContent = '0';
        return;
      }

      filteredQuestions.forEach(q => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded mb-2 dark:bg-gray-700 dark:text-gray-100';

        const time = formatTime(q.timestamp);
        li.innerHTML = `
          <span>
            <i class="fas fa-clock mr-2"></i>${time} - ${q.text}
            ${
              q.difficulty 
                ? `<span class="ml-2 text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 dark:bg-blue-200">[${q.difficulty}]</span>`
                : ''
            }
          </span>
          <div class="flex space-x-3 items-center">
            <!-- Clone button -->
            <button 
              class="text-green-500 dark:text-green-400" 
              onclick="cloneQuestion(${questions.indexOf(q)})"
              aria-label="Clone Question"
            >
              <i class="fas fa-clone"></i>
            </button>
            <button 
              class="text-blue-500 dark:text-blue-400" 
              onclick="editQuestion(${questions.indexOf(q)})" 
              aria-label="Edit Question"
            >
              <i class="fas fa-edit"></i>
            </button>
            <button 
              class="text-red-500 dark:text-red-400" 
              onclick="removeQuestion(${questions.indexOf(q)})" 
              aria-label="Delete Question"
            >
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `;
        questionList.appendChild(li);
      });

      // Update total questions
      totalQuestionsEl.textContent = filteredQuestions.length.toString();
    }

    // Clone Question
    function cloneQuestion(index) {
      const original = questions[index];
      // We can clone it with a slightly different timestamp or the same
      const newQuestion = {
        ...original,
        displayed: false,
        notified: false,
        answered: false,
        timestamp: original.timestamp + 5 // Add 5s to the original timestamp by default
      };
      questions.push(newQuestion);
      saveQuestions();
      renderAll();
      alert('Question cloned! Timestamp offset by +5 seconds.');
    }

    // Render Upcoming Questions
    function renderUpcomingQuestions() {
      upcomingQuestionsList.innerHTML = '';
      if (questions.length === 0) {
        const li = document.createElement('li');
        li.className = 'text-gray-500';
        li.textContent = 'No upcoming questions.';
        upcomingQuestionsList.appendChild(li);
        return;
      }
      const currentTime = videoPlayer.currentTime;
      const upcoming = questions
        .filter(q => q.timestamp > currentTime && !q.displayed)
        .sort((a, b) => a.timestamp - b.timestamp);

      if (upcoming.length === 0) {
        const li = document.createElement('li');
        li.className = 'text-gray-500';
        li.textContent = 'No upcoming questions.';
        upcomingQuestionsList.appendChild(li);
        return;
      }
      upcoming.forEach(q => {
        const li = document.createElement('li');
        li.className = 'flex items-center mb-1';
        const time = formatTime(q.timestamp);
        li.innerHTML = `
          <i class="fas fa-question-circle text-blue-500 mr-2"></i>
          <span>${time} - ${q.text}</span>
        `;
        upcomingQuestionsList.appendChild(li);
      });
    }

    // Edit Question
    function editQuestion(index) {
      const question = questions[index];
      modalTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Question';
      editIndexInput.value = index;

      questionType.value = question.type;
      difficultySelect.value = question.difficulty || '';
      document.getElementById('questionTextInput').value = question.text;
      document.getElementById('timestamp').value = question.timestamp;
      document.getElementById('explanationInput').value = question.explanation || '';
      questionTimerInput.value = question.timeLimit || 0;
      allowSkipCheckbox.checked = question.allowSkip || false;

      handleQuestionTypeUI(question.type);

      if (question.type === 'multiple_choice' || question.type === 'true_false') {
        const optionInputs = document.querySelectorAll('.option-input');
        optionInputs.forEach((input, idx) => {
          if (idx < question.options.length) {
            input.value = question.options[idx];
          } else {
            input.value = '';
          }
        });
        const correctOptionRadio = document.querySelector(`input[name="correctOption"][value="${question.correctAnswer}"]`);
        if (correctOptionRadio) {
          correctOptionRadio.checked = true;
        }
      } else {
        document.getElementById('correctAnswer').value = question.correctAnswer;
      }
      openAddQuestionModal();
    }

    // Remove Question
    function removeQuestion(index) {
      if (confirm('Are you sure you want to delete this question?')) {
        questions.splice(index, 1);
        saveQuestions();
        renderAll();
      }
    }

    // Format time in seconds to MM:SS
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Video Time Update Handler
    videoPlayer.addEventListener('timeupdate', () => {
      const currentTime = videoPlayer.currentTime;

      questions.forEach((q, index) => {
        // For upcoming question notification
        if (!q.notified && (q.timestamp - 5) <= currentTime && currentTime < q.timestamp) {
          q.notified = true;
          saveQuestions();
          showUpcomingNotification(q, index);
        }

        // Show question if currentTime is at or near timestamp
        if (Math.abs(currentTime - q.timestamp) < 0.5 && !q.displayed) {
          q.displayed = true;
          saveQuestions();
          displayQuestion(q, index);
        }
      });
      // Update upcoming questions
      renderUpcomingQuestions();
    });

    // Show Upcoming Question Notification
    function showUpcomingNotification(question, index) {
      let countdown = 5;
      countdownElement.textContent = countdown;
      upcomingNotification.classList.remove('hidden');

      countdownInterval = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          upcomingNotification.classList.add('hidden');
        } else {
          countdownElement.textContent = countdown;
        }
      }, 1000);

      countdownTimer = setTimeout(() => {
        upcomingNotification.classList.add('hidden');
      }, 5000);
    }

    // Display question and pause video
    function displayQuestion(question, index) {
      currentQuestionIndex = index;
      activeQuestionData   = question;
      userHasAttempted     = false;

      questionText.textContent   = question.text;
      questionOptions.innerHTML  = '';
      feedback.innerHTML         = '';
      explanationDiv.innerHTML   = '';
      skipBtn.classList.add('hidden');

      // Build question form
      if (question.type === 'multiple_choice') {
        let opts = [...question.options];
        if (shuffleMultipleChoiceOptions) {
          shuffleArray(opts);
        }
        opts.forEach((opt, idx) => {
          const option = document.createElement('div');
          option.className = 'flex items-center mb-2';
          option.innerHTML = `
            <input type="radio" name="answer" value="${opt}" class="mr-2" />
            <label>${opt}</label>
          `;
          questionOptions.appendChild(option);
        });
      } else if (question.type === 'fill_in_blank' || question.type === 'short_answer') {
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'studentAnswer';
        input.className = 'w-full border border-gray-300 rounded p-2';
        questionOptions.appendChild(input);
      } else if (question.type === 'true_false') {
        ['True', 'False'].forEach(opt => {
          const option = document.createElement('div');
          option.className = 'flex items-center mb-2';
          option.innerHTML = `
            <input type="radio" name="answer" value="${opt}" class="mr-2" />
            <label>${opt}</label>
          `;
          questionOptions.appendChild(option);
        });
      }

      if (questionCountdownInterval) {
        clearInterval(questionCountdownInterval);
      }
      timerText.textContent = '';

      // If question has time limit
      if (question.timeLimit && question.timeLimit > 0) {
        let timeLeft = question.timeLimit;
        timerText.textContent = `Time left: ${timeLeft}s`;

        questionCountdownInterval = setInterval(() => {
          timeLeft--;
          timerText.textContent = `Time left: ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(questionCountdownInterval);
            feedback.innerHTML = `
              <span class="text-red-500 font-semibold">Time's up!</span>
              <br />
              <span>Correct Answer: ${getFormattedCorrectAnswer(question)}</span>
            `;
            incorrectAnswersCount++;
            question.answered = true;
            saveScores();
            updateScoreboard();
            disableInputs();
            setTimeout(() => {
              closeQuestion();
              videoPlayer.play();
            }, 3000);
          }
        }, 1000);
      }

      // Pause video
      videoPlayer.pause();
      activeQuestion.classList.remove('hidden');
    }

    // Get formatted correct answer based on question type
    function getFormattedCorrectAnswer(question) {
      if (question.type === 'multiple_choice' || question.type === 'true_false') {
        const optionIndex = question.correctAnswer.charCodeAt(0) - 65;
        return question.options[optionIndex] || question.correctAnswer;
      }
      return question.correctAnswer;
    }

    // Submit Answer
    function submitAnswer() {
      if (!activeQuestionData || userHasAttempted) return;  

      const question = activeQuestionData;
      let studentAnswer = '';
      if (question.type === 'multiple_choice' || question.type === 'true_false') {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (selected) {
          studentAnswer = selected.value.trim();
        }
      } else {
        const input = document.getElementById('studentAnswer');
        if (input) {
          studentAnswer = input.value.trim();
        }
      }

      if (!studentAnswer) {
        alert('Please provide an answer or skip if allowed.');
        return;
      }
      userHasAttempted = true;

      if (questionCountdownInterval) {
        clearInterval(questionCountdownInterval);
      }
      timerText.textContent = '';

      let isCorrect = false;
      if (question.type === 'multiple_choice') {
        const correctLetter = question.correctAnswer.toUpperCase();
        const letterIndex   = correctLetter.charCodeAt(0) - 65; 
        const correctText   = question.options[letterIndex] 
          ? question.options[letterIndex].trim().toLowerCase() 
          : '';
        isCorrect = (studentAnswer.toLowerCase() === correctText);
      }
      else if (question.type === 'true_false') {
        isCorrect = (studentAnswer.toLowerCase() === question.correctAnswer.toLowerCase());
      }
      else {
        isCorrect = (studentAnswer.toLowerCase() === question.correctAnswer.toLowerCase());
      }

      if (isCorrect) {
        feedback.innerHTML = '<span class="text-green-500 font-semibold">Correct!</span>';
        correctAnswersCount++;
      } else {
        feedback.innerHTML = `
          <span class="text-red-500 font-semibold">Incorrect!</span>
          <br />
          <span>Correct Answer: ${getFormattedCorrectAnswer(question)}</span>
        `;
        incorrectAnswersCount++;
        if (question.explanation) {
          explanationDiv.innerHTML = `<strong>Explanation:</strong> ${question.explanation}`;
        }
      }
      question.answered = true;
      saveScores();
      updateScoreboard();
      disableInputs();

      setTimeout(() => {
        closeQuestion();
        videoPlayer.play();
      }, 3000);
    }

    // Skip Question
    function skipQuestion() {
      if (!activeQuestionData) return;
      userHasAttempted = true;

      if (questionCountdownInterval) {
        clearInterval(questionCountdownInterval);
      }
      timerText.textContent = '';

      feedback.innerHTML = '<span class="text-yellow-500 font-semibold">Skipped!</span>';
      disableInputs();
      setTimeout(() => {
        closeQuestion();
        videoPlayer.play();
      }, 2000);
    }

    // Disable question inputs
    function disableInputs() {
      const inputs = activeQuestion.querySelectorAll('input');
      inputs.forEach(input => input.disabled = true);
      submitAnswerBtn.disabled = true;
      skipBtn.disabled         = true;
    }

    // Close Question
    function closeQuestion() {
      activeQuestion.classList.add('hidden');
      submitAnswerBtn.disabled = false;
      skipBtn.disabled         = false;
      if (questionCountdownInterval) {
        clearInterval(questionCountdownInterval);
      }
      questionCountdownInterval = null;
    }

    // End of Video -> Show Summary
    function onVideoEnded() {
      endTotalQsEl.textContent     = questions.length.toString();
      endCorrectEl.textContent     = correctAnswersCount.toString();
      endIncorrectEl.textContent   = incorrectAnswersCount.toString();
      endReviewList.innerHTML      = '';

      questions.forEach((q, idx) => {
        const li = document.createElement('li');
        li.className = 'p-2 rounded border border-gray-200 dark:border-gray-700';
        li.innerHTML = `
          <strong>Question ${idx+1}:</strong> ${q.text}
          <br />
          <span class="text-xs text-gray-500">Answer: ${getFormattedCorrectAnswer(q)}</span>
          <br />
          ${
            q.answered
              ? `<span class="text-green-600">Answered</span>`
              : `<span class="text-red-600">Not Answered / Skipped</span>`
          }
        `;
        endReviewList.appendChild(li);
      });

      toggleModal('endSummaryModal');
    }

    // Close End Summary
    function closeEndSummaryModal() {
      toggleModal('endSummaryModal');
    }

    // Toggle Modals
    function toggleModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.toggle('hidden');
    }

    function openAddQuestionModal() {
      modalTitle.innerHTML = '<i class="fas fa-question-circle"></i> Add New Question';
      questionForm.reset();
      optionsContainer.classList.add('hidden');
      correctAnswerContainer.classList.remove('hidden');
      editIndexInput.value = '';
      toggleModal('addQuestionModal');
    }
    function closeAddQuestionModal() {
      toggleModal('addQuestionModal');
      modalTitle.innerHTML = '<i class="fas fa-question-circle"></i> Add New Question';
      questionForm.reset();
      optionsContainer.classList.add('hidden');
      correctAnswerContainer.classList.remove('hidden');
      editIndexInput.value = '';
    }

    function openQuickAddModal() {
      quickAddForm.reset();
      // Reset radio buttons
      const radios = quickAddForm.querySelectorAll('input[name="quickCorrectOption"]');
      radios.forEach(radio => radio.checked = false);
      toggleModal('quickAddModal');
    }
    function closeQuickAddModal() {
      toggleModal('quickAddModal');
      quickAddForm.reset();
    }

    function openImportModal() {
      importForm.reset();
      toggleModal('importModal');
    }
    function closeImportModal() {
      toggleModal('importModal');
      importForm.reset();
    }

    function openCSVModal() {
      csvForm.reset();
      toggleModal('csvModal');
    }
    function closeCSVModal() {
      toggleModal('csvModal');
      csvForm.reset();
    }

    // Reset All Data
    function resetData() {
      if (confirm('Are you sure you want to reset all data? This will remove the uploaded video and all questions.')) {
        localStorage.clear();
        videoPlayer.pause();
        videoPlayer.src = '';
        videoCard.classList.add('hidden');
        questions = [];
        correctAnswersCount   = 0;
        incorrectAnswersCount = 0;
        renderAll();
        closeQuestion();
        clearTimeout(countdownTimer);
        clearInterval(countdownInterval);
        upcomingNotification.classList.add('hidden');
      }
    }

    // Export Questions as JSON
    function exportQuestions() {
      if (questions.length === 0) {
        alert('No questions to export.');
        return;
      }
      const dataStr = JSON.stringify(questions, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'questions.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Handle Import JSON Form
    importForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const file = importFile.files[0];
      if (!file) {
        alert('Please select a JSON file to import.');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const importedQuestions = JSON.parse(event.target.result);
          if (!Array.isArray(importedQuestions)) {
            throw new Error('Invalid format. JSON should be an array of questions.');
          }
          for (let q of importedQuestions) {
            if (!q.type || !q.text || !q.correctAnswer || q.timestamp === undefined) {
              throw new Error('Invalid question format.');
            }
            if ((q.type === 'multiple_choice' || q.type === 'true_false') && (!q.options || !Array.isArray(q.options))) {
              throw new Error('Multiple Choice / True/False must have an array of options.');
            }
          }
          questions = questions.concat(
            importedQuestions.map(q => ({
              ...q,
              displayed: false,
              notified: false,
              answered: false
            }))
          );
          saveQuestions();
          renderAll();
          closeImportModal();
          alert('Questions imported successfully.');
        } catch (error) {
          alert('Error importing questions: ' + error.message);
        }
      };
      reader.readAsText(file);
    });

    // Handle Import CSV Form
    csvForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const file = csvFile.files[0];
      if (!file) {
        alert('Please select a CSV file.');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(event) {
        const text = event.target.result;
        parseCSV(text);
      };
      reader.readAsText(file);
    });

    function parseCSV(csvText) {
      const lines = csvText.trim().split(/\r?\n/);
      for (let i = 0; i < lines.length; i++) {
        const row = lines[i].split(',');
        // row = [question_text, optionA, optionB, optionC, optionD, correctOption, timestamp, ...]
        if (row.length < 7) {
          console.warn(`Skipping line ${i+1}, not enough columns.`);
          continue;
        }
        const questionText  = row[0].trim();
        const optionA       = row[1].trim();
        const optionB       = row[2].trim();
        const optionC       = row[3].trim();
        const optionD       = row[4].trim();
        let correctOption   = row[5].trim().toUpperCase();
        let timestamp       = parseFloat(row[6]);

        if (!['A','B','C','D'].includes(correctOption)) {
          console.warn(`Line ${i+1}: Invalid correct option. Must be A,B,C,D.`);
          continue;
        }
        if (isNaN(timestamp) || timestamp < 0) {
          console.warn(`Line ${i+1}: Invalid timestamp.`);
          continue;
        }
        // Snap to end if needed
        if (videoPlayer.duration && timestamp > videoPlayer.duration) {
          timestamp = Math.floor(videoPlayer.duration) - 1;
        }

        const newMCQ = {
          type: 'multiple_choice',
          difficulty: '',
          text: questionText,
          options: [optionA, optionB, optionC, optionD].filter(o => o),
          correctAnswer: correctOption,
          explanation: '',
          timestamp,
          timeLimit: 0,
          allowSkip: false,
          displayed: false,
          notified: false,
          answered: false
        };
        questions.push(newMCQ);
      }
      saveQuestions();
      renderAll();
      closeCSVModal();
      alert('CSV imported successfully.');
    }

    // Utility: Shuffle array in place
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // Apply filters
    function applyFilters(allQuestions) {
      const searchTerm = searchInput.value.toLowerCase();
      const typeFilter = filterTypeSelect.value;
      const diffFilter = filterDifficulty.value;

      return allQuestions.filter(q => {
        const inSearch = q.text.toLowerCase().includes(searchTerm);
        const inType   = !typeFilter || q.type === typeFilter;
        const inDiff   = !diffFilter || q.difficulty === diffFilter;
        return inSearch && inType && inDiff;
      });
    }

    // Filter Questions
    function filterQuestions() {
      renderQuestionList();
    }

    // Save questions to localStorage
    function saveQuestions() {
      localStorage.setItem('questions', JSON.stringify(questions));
    }

    // Save scores to localStorage
    function saveScores() {
      localStorage.setItem('correctCount', correctAnswersCount.toString());
      localStorage.setItem('incorrectCount', incorrectAnswersCount.toString());
    }

    // Update scoreboard
    function updateScoreboard() {
      scoreText.textContent         = (correctAnswersCount + incorrectAnswersCount).toString();
      correctCountEl.textContent    = correctAnswersCount.toString();
      incorrectCountEl.textContent  = incorrectAnswersCount.toString();
    }
  </script>
</body>
</html>
